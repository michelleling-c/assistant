<!DOCTYPE html>
<html lang="zh-Hant-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºå‹ä¼´ - è€å‹è¨˜åŠ©æ‰‹</title>
    <style>
        :root {
            --primary-yellow: #facc15;
            --light-yellow: #fef9c3;
            --btn-hover: #eab308;
            --bg-color: #cfd1bb;
            --card-bg: var(--light-yellow);
            --border-black: #000000;
            --ai-sparkle: #8b5cf6;
        }

        body {
            background-color: var(--bg-color);
            color: #000000;
            font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            background-color: var(--primary-yellow);
            border-bottom: 3px solid var(--border-black);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-main { display: flex; align-items: center; gap: 8px; }
        .heart-icon { color: #cc3333; width: 28px; height: 28px; }
        h1 { margin: 0; font-size: 1.6rem; font-weight: 900; }
        
        .test-voice-btn {
            background: #fff;
            border: 2px solid #000;
            padding: 8px 15px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 2px 2px 0 #000;
        }

        .info-container {
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        .info-row { display: flex; gap: 12px; width: 100%; }
        
        .info-box {
            background: var(--card-bg);
            border: 3px solid var(--border-black);
            border-radius: 20px;
            padding: 20px 15px;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.3);
        }

        .info-label { font-size: 1rem; color: #333; font-weight: bold; margin-bottom: 4px; }
        /* æ”¾å¤§å­—é«”ï¼šæ™‚é–“èˆ‡æ—¥æœŸ */
        .info-value { font-size: 2.2rem; font-weight: 900; line-height: 1.2; }
        .date-detail { font-size: 1.2rem; font-weight: 900; display: block; }
        .icon-large { font-size: 2.5rem; }

        #chat-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            width: 90%;
            margin: 5px auto;
            padding: 15px;
            font-size: 1.4rem;
            font-weight: bold;
            border: 3px solid var(--border-black);
            border-radius: 20px;
            background-color: #ffffff;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
        }

        .user-msg { background-color: #fef08a; align-self: flex-end; text-align: right; }
        .ai-badge { font-size: 0.7rem; color: var(--ai-sparkle); display: block; margin-top: 5px; }

        footer {
            padding: 10px 20px 30px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            background: var(--bg-color);
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
        }

        input {
            flex: 1;
            padding: 12px;
            border: 3px solid var(--border-black);
            border-radius: 15px;
            font-size: 1.1rem;
        }

        .action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .big-btn {
            background-color: var(--primary-yellow);
            border: 3px solid var(--border-black);
            border-radius: 15px;
            padding: 12px;
            font-size: 1.2rem;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            box-shadow: 0 4px 0 var(--border-black);
        }

        .voice-btn {
            grid-column: span 2;
            background-color: #f5f3ff;
            color: var(--ai-sparkle);
            border-color: var(--ai-sparkle);
        }

        .recording { background-color: #ef4444 !important; color: white !important; border-color: #000 !important; }

        .big-btn:active { transform: translateY(2px); box-shadow: 0 1px 0 var(--border-black); }
        #loading-ai { text-align: center; color: var(--ai-sparkle); font-weight: bold; display: none; margin-bottom: 5px; }
    </style>
</head>
<body>

<header>
    <div class="header-main">
        <svg class="heart-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
        <h1>æ™ºå‹ä¼´</h1>
    </div>
    <button class="test-voice-btn" onclick="testVoice()">ğŸ”Š è©¦è²</button>
</header>

<div class="info-container">
    <div class="info-row">
        <div class="info-box">
            <span class="icon-large">ğŸ•’</span>
            <div>
                <div class="info-label">æ™‚é–“</div>
                <div id="info-time" class="info-value">--:--</div>
            </div>
        </div>
        <div class="info-box">
            <span class="icon-large">ğŸ“…</span>
            <div>
                <div class="info-label">æ—¥æœŸ</div>
                <div id="info-date" class="info-value">--æœˆ--æ—¥</div>
                <div id="info-year-week" class="date-detail">----å¹´ (---)</div>
            </div>
        </div>
    </div>
</div>

<div id="chat-area">
    <div id="chat-bubble" class="message">
        è€å‹è¨˜ï¼Œä½ å¥½ï¼ä»Šæ—¥æƒ³çŸ¥å¹¾è™Ÿã€ç‡å¤©æ°£ï¼Œå®šä¿‚æƒ³åŒæˆ‘å‚¾ä¸‹è¨ˆï¼Ÿ
    </div>
</div>

<footer>
    <div id="loading-ai">âœ¨ æ™ºå‹ä¼´è«—ç·Šé»åŒä½ è¬›...</div>
    <div class="input-group">
        <input type="text" id="user-input" placeholder="æ‰“å­—åŒæˆ‘å‚¾è¨ˆ...">
        <button class="big-btn" onclick="askGemini()" style="padding: 0 20px; box-shadow: 0 4px 0 #000;">ç™¼é€</button>
    </div>
    <div class="action-grid">
        <button id="voice-trigger" class="big-btn voice-btn">ğŸ™ï¸ <span>æ’³ä½åŒæˆ‘å‚¾è¨ˆ / è¬›å˜¢</span></button>
        <button class="big-btn" onclick="handleAction('weather')">â˜€ï¸ ä»Šæ—¥å¤©æ°£é»å‘€</button>
        <button class="big-btn" onclick="handleAction('festival')">ğŸ§§ åšŸç·Šå’©ç¯€æ—¥</button>
    </div>
</footer>

<script>
    const apiKey = ""; 
    const synth = window.speechSynthesis;
    let voices = [];

    function loadVoices() {
        voices = synth.getVoices();
        if (voices.length === 0) setTimeout(loadVoices, 100);
    }
    if ('onvoiceschanged' in synth) synth.onvoiceschanged = loadVoices;
    loadVoices();

    function speak(text) {
        if (!synth) return;
        synth.cancel(); 
        const utter = new SpeechSynthesisUtterance(text);
        const cantoneseVoice = voices.find(v => v.lang === 'zh-HK' || v.lang.includes('yue-HK') || v.lang.includes('HK'));
        if (cantoneseVoice) utter.voice = cantoneseVoice;
        utter.lang = 'zh-HK';
        utter.rate = 0.95; 
        synth.speak(utter);
    }

    function addMessage(sender, text, isAi = false) {
        const chatArea = document.getElementById('chat-area');
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${sender === 'user' ? 'user-msg' : ''}`;
        msgDiv.innerHTML = text + (isAi ? `<span class="ai-badge">âœ¨ ç”± Gemini AI æ™ºèƒ½ç”Ÿæˆ</span>` : "");
        chatArea.appendChild(msgDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
        if (sender === 'bot') speak(text);
    }

    function getTimeOfDay() {
        const hour = new Date().getHours();
        if (hour >= 5 && hour < 12) return "æ—©æ™¨";
        if (hour >= 12 && hour < 18) return "åˆå®‰";
        if (hour >= 18 || hour < 5) return "æ™šå®‰";
        return "ä½ å¥½";
    }

    async function callGemini(prompt) {
        document.getElementById('loading-ai').style.display = 'block';
        const now = new Date();
        const timeGreet = getTimeOfDay();
        
        const systemPrompt = `ä½ æ˜¯ã€æ™ºå‹ä¼´ã€ï¼Œé¦™æ¸¯é•·è€…çš„è²¼å¿ƒæœ‹å‹ã€‚
        ç•¶å‰æ™‚é–“ï¼š${now.toLocaleString('zh-HK')}ï¼Œç¾åœ¨æ˜¯ã€Œ${timeGreet}ã€ã€‚
        åŸå‰‡ï¼š
        1. çµ•å°ä¸å¯æä¾›éŒ¯èª¤è³‡è¨Šã€‚è‹¥ä¸ç¢ºå®šï¼Œè«‹èª å¯¦å›ç­”ä¸çŸ¥é“ã€‚
        2. å¦‚æœè€å‹è¨˜è¬›éŒ¯æ™‚é–“å•å€™èªï¼ˆä¾‹å¦‚æ—©ä¸Šè¬›æ™šå®‰ï¼Œæˆ–æ™šä¸Šè¬›æ—©æ™¨ï¼‰ï¼Œè«‹æº«é¦¨ã€æ¥µå…¶æœ‰ç¦®è²Œåœ°ç³¾æ­£ã€‚
        3. ä½¿ç”¨åœ°é“å»£æ±è©±ï¼Œå›è¦†è¦ç²¾ç°¡ã€ç›´æ¥ã€‚
        4. å­—æ•¸ä¿æŒåœ¨40å­—å…§ã€‚`;
        
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                })
            });
            const data = await response.json();
            document.getElementById('loading-ai').style.display = 'none';
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "è½å””æ¸…æ¥šï¼Œå†è¬›ä¸€æ¬¡å¥½å—ï¼Ÿ";
        } catch (e) {
            document.getElementById('loading-ai').style.display = 'none';
            return "é€£ç·šå””ä¿‚å¹¾å¥½ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
        }
    }

    async function askGemini(textOverride = null) {
        const input = document.getElementById('user-input');
        const text = textOverride || input.value.trim();
        if (!text) return;
        addMessage('user', text);
        input.value = '';
        const reply = await callGemini(text);
        addMessage('bot', reply, true);
    }

    function updateClock() {
        const now = new Date();
        const days = ["æ˜ŸæœŸæ—¥","æ˜ŸæœŸä¸€","æ˜ŸæœŸäºŒ","æ˜ŸæœŸä¸‰","æ˜ŸæœŸå››","æ˜ŸæœŸäº”","æ˜ŸæœŸå…­"];
        
        // æ›´æ–°æ™‚é–“
        document.getElementById('info-time').innerText = now.toLocaleTimeString('zh-HK', { hour: '2-digit', minute: '2-digit', hour12: false });
        
        // æ›´æ–°æ—¥æœŸ
        document.getElementById('info-date').innerText = `${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥`;
        document.getElementById('info-year-week').innerText = `${now.getFullYear()}å¹´ (${days[now.getDay()]})`;
    }

    function getNextFestival(date) {
        const year = date.getFullYear();
        const festivals = [
            { name: "7æœˆ1æ—¥å›æ­¸ç´€å¿µæ—¥", month: 7, day: 1, custom: "ä¿‚é¦™æ¸¯å›æ­¸ç¥–åœ‹å˜…æ—¥å­ï¼Œå‘¨åœéƒ½æœ‰æ…¶ç¥æ´»å‹•ã€‚" },
            { name: "10æœˆ1æ—¥åœ‹æ…¶", month: 10, day: 1, custom: "æ…¶ç¥åœ‹æ…¶ï¼Œå¤œæ™šé€šå¸¸æœ‰ç…™èŠ±åŒ¯æ¼”ã€‚" },
            { name: "è–èª•ç¯€", month: 12, day: 25, custom: "å‘¨åœéƒ½æœ‰éšç‡ˆé£¾ï¼Œå¯ä»¥åŒè¦ªå‹é–‹å¤§é¤ã€‚" }
        ];

        const lunarData = {
            2024: { cny: [2, 10], qm: [4, 4], db: [6, 10], ma: [9, 17], cy: [10, 11], wz: [12, 21] },
            2025: { cny: [1, 29], qm: [4, 4], db: [5, 31], ma: [10, 6], cy: [10, 29], wz: [12, 21] },
            2026: { cny: [2, 17], qm: [4, 5], db: [6, 19], ma: [9, 25], cy: [10, 18], wz: [12, 22] }
        };

        const currentYearData = lunarData[year] || lunarData[2025];
        
        festivals.push(
            { name: "è¾²æ›†æ–°å¹´", month: currentYearData.cny[0], day: currentYearData.cny[1], custom: "è¨˜å¾—è¦å¤§æƒé™¤åŒè²¼æ®æ˜¥ï¼Œä¸€å®¶äººé£Ÿåœ˜å¹´é£¯ã€‚" },
            { name: "æ¸…æ˜ç¯€", month: currentYearData.qm[0], day: currentYearData.qm[1], custom: "æ…çµ‚è¿½é ï¼Œå¤§å®¶æœƒå»æ‹œå±±æƒå¢“ã€‚" },
            { name: "ç«¯åˆç¯€", month: currentYearData.db[0], day: currentYearData.db[1], custom: "é£Ÿç²½ã€ç‡é¾èˆŸï¼Œä»²å¯ä»¥æ¸¸é¾èˆŸæ°´ã€‚" },
            { name: "ä¸­ç§‹ç¯€", month: currentYearData.ma[0], day: currentYearData.ma[1], custom: "é£Ÿæœˆé¤…è³æœˆï¼Œç¥ä½ ä¸€å®¶äººåœ˜åœ˜åœ“åœ“ã€‚" },
            { name: "é‡é™½ç¯€", month: currentYearData.cy[0], day: currentYearData.cy[1], custom: "å¯ä»¥åŒå±‹ä¼äººç™»é«˜æœ›é æˆ–è€…å»ç¥­ç¥–ã€‚" },
            { name: "å†¬è‡³", month: currentYearData.wz[0], day: currentYearData.wz[1], custom: "å†¬å¤§éå¹´ï¼Œè¨˜å¾—é£Ÿç¢—æš–æ¹¯åœ“å‘€ã€‚" }
        );

        const todayNum = (date.getMonth() + 1) * 100 + date.getDate();
        festivals.sort((a, b) => (a.month * 100 + a.day) - (b.month * 100 + b.day));
        
        let next = festivals.find(f => (f.month * 100 + f.day) >= todayNum);
        if (!next) next = festivals[0];

        return next;
    }

    async function handleAction(type) {
        const now = new Date();
        updateClock();

        if (type === 'weather') {
            try {
                const res = await fetch('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rhrread&lang=tc');
                const data = await res.json();
                const warnRes = await fetch('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=warningInfo&lang=tc');
                const warnData = await warnRes.json();
                
                const temp = data.temperature.data[0].value;
                const humidity = data.humidity.data[0].value;
                
                let warning = "ç¾æ™‚å†‡ç”Ÿæ•ˆå˜…å¤©æ°£è­¦å‘Šã€‚";
                if (warnData && warnData.details && warnData.details.length > 0) {
                    warning = "æ³¨æ„ï¼šç¾æ™‚æœ‰ã€Œ" + warnData.details[0].contents.join("ã€") + "ã€è­¦å‘Šã€‚";
                }

                const report = `æ°£æº« ${temp}åº¦ï¼Œæ¿•åº¦ç™¾åˆ†ä¹‹ ${humidity}ã€‚${warning}`;
                addMessage('bot', report);
            } catch(e) { 
                addMessage('bot', "æš«æ™‚é€£å””åˆ°å¤©æ–‡å°ï¼Œä¸éè¨˜å¾—å‡ºå…¥è‘—å¤šä»¶è¡«å‘€ã€‚"); 
            }
        } 
        else if (type === 'festival') {
            const next = getNextFestival(now);
            const report = `åšŸç·Šå˜…ç¯€æ—¥ä¿‚ ${next.name}ã€‚ç¿’ä¿—æ–¹é¢ï¼š${next.custom}`;
            addMessage('bot', report);
        }
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
        const recognition = new SpeechRecognition();
        recognition.lang = 'zh-HK';
        const btn = document.getElementById('voice-trigger');
        btn.onmousedown = btn.ontouchstart = (e) => {
            e.preventDefault();
            btn.classList.add('recording');
            btn.querySelector('span').innerText = 'è½ç·Šä½ è¬›å˜¢...';
            recognition.start();
        };
        btn.onmouseup = btn.ontouchend = () => {
            btn.classList.remove('recording');
            btn.querySelector('span').innerText = 'æ’³ä½åŒæˆ‘å‚¾è¨ˆ / è¬›å˜¢';
            recognition.stop();
        };
        recognition.onresult = (e) => askGemini(e.results[0][0].transcript);
    }

    function testVoice() {
        speak("æ¸¬è©¦æˆåŠŸï¼è€å‹è¨˜ï¼Œè½åˆ°æˆ‘è¬›å˜¢å—ï¼Ÿ");
    }

    window.onload = () => {
        updateClock();
        setInterval(updateClock, 1000);
        loadVoices();
        const timeGreet = getTimeOfDay();
        document.getElementById('chat-bubble').innerText = `è€å‹è¨˜ï¼Œ${timeGreet}ï¼ä»Šæ—¥æƒ³ç‡å¤©æ°£ï¼Œå®šä¿‚æƒ³åŒæˆ‘å‚¾ä¸‹è¨ˆï¼Ÿ`;
    };
    
    document.getElementById('user-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') askGemini();
    });
</script>
</body>
</html>
