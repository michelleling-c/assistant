<!DOCTYPE html>
<html lang="zh-Hant-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºå‹ä¼´ - è€å‹è¨˜åŠ©æ‰‹</title>
    <style>
        :root {
            --primary-yellow: #facc15;
            --light-yellow: #fef9c3;
            --btn-hover: #eab308;
            --bg-color: #cfd1bb;
            --card-bg: var(--light-yellow);
            --border-black: #000000;
            --ai-sparkle: #8b5cf6;
        }

        body {
            background-color: var(--bg-color);
            color: #000000;
            font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            background-color: var(--primary-yellow);
            border-bottom: 3px solid var(--border-black);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-main { display: flex; align-items: center; gap: 8px; }
        .heart-icon { color: #cc3333; width: 28px; height: 28px; }
        h1 { margin: 0; font-size: 1.6rem; font-weight: 900; }
        
        .test-voice-btn {
            background: #fff;
            border: 2px solid #000;
            padding: 8px 15px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 2px 2px 0 #000;
        }

        .info-container {
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            max-width: 700px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        .info-row { display: flex; gap: 10px; width: 100%; }
        
        .info-box {
            background: var(--card-bg);
            border: 3px solid var(--border-black);
            border-radius: 20px;
            padding: 15px;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.3);
        }

        .info-label { font-size: 0.9rem; color: #333; font-weight: bold; }
        .info-value { font-size: 1.8rem; font-weight: 900; }
        .icon-large { font-size: 2rem; }

        #chat-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            width: 90%;
            margin: 5px auto;
            padding: 15px;
            font-size: 1.4rem;
            font-weight: bold;
            border: 3px solid var(--border-black);
            border-radius: 20px;
            background-color: #ffffff;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
        }

        .user-msg { background-color: #fef08a; align-self: flex-end; text-align: right; }
        .ai-badge { font-size: 0.7rem; color: var(--ai-sparkle); display: block; margin-top: 5px; }

        footer {
            padding: 10px 20px 30px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            background: var(--bg-color);
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
        }

        input {
            flex: 1;
            padding: 12px;
            border: 3px solid var(--border-black);
            border-radius: 15px;
            font-size: 1.1rem;
        }

        .action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .big-btn {
            background-color: var(--primary-yellow);
            border: 3px solid var(--border-black);
            border-radius: 15px;
            padding: 12px;
            font-size: 1.2rem;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            box-shadow: 0 4px 0 var(--border-black);
        }

        .voice-btn {
            grid-column: span 2;
            background-color: white;
            color: #000;
        }

        .recording { background-color: #ef4444 !important; color: white !important; }

        .big-btn:active { transform: translateY(2px); box-shadow: 0 1px 0 var(--border-black); }
        #loading-ai { text-align: center; color: var(--ai-sparkle); font-weight: bold; display: none; margin-bottom: 5px; }
    </style>
</head>
<body>

<header>
    <div class="header-main">
        <svg class="heart-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
        <h1>æ™ºå‹ä¼´</h1>
    </div>
    <button class="test-voice-btn" onclick="testVoice()">ğŸ”Š è©¦è²</button>
</header>

<div class="info-container">
    <div class="info-row">
        <div class="info-box">
            <span class="icon-large">ğŸ•’</span>
            <div>
                <div class="info-label">æ™‚é–“</div>
                <div id="info-time" class="info-value">--:--</div>
            </div>
        </div>
        <div class="info-box">
            <span class="icon-large">ğŸ“…</span>
            <div>
                <div class="info-label">æ—¥æœŸ</div>
                <div id="info-date" class="info-value">--/--</div>
            </div>
        </div>
    </div>
</div>

<div id="chat-area">
    <div id="chat-bubble" class="message">
        è€å‹è¨˜ï¼Œä½ å¥½ï¼æƒ³çŸ¥ä»Šæ—¥å¹¾è™Ÿã€è½ä¸‹ç¯€æ…¶ç¿’ä¿—ï¼Œå®šä¿‚åŒæˆ‘å‚¾åˆï¼Ÿ
    </div>
</div>

<footer>
    <div id="loading-ai">âœ¨ æ™ºå‹ä¼´è«—ç·Šé»åŒä½ è¬›...</div>
    <div class="input-group">
        <input type="text" id="user-input" placeholder="æƒ³åŒæˆ‘è¬›å’©ï¼Ÿ">
        <button class="big-btn" onclick="askGemini()" style="padding: 0 20px; box-shadow: 0 4px 0 #000;">ç™¼é€</button>
    </div>
    <div class="action-grid">
        <button id="voice-trigger" class="big-btn voice-btn">ğŸ™ï¸ <span>æ’³ä½è¬›å˜¢</span></button>
        <button class="big-btn" onclick="handleAction('date')">ğŸ—“ï¸ ä»Šæ—¥å¹¾è™Ÿ</button>
        <button class="big-btn" onclick="handleAction('weather')">â˜€ï¸ å¤©æ°£é»å‘€</button>
        <button class="big-btn" onclick="handleAction('festival')" style="grid-column: span 2; background-color: #f5f3ff; border-color: var(--ai-sparkle); color: var(--ai-sparkle);">ğŸ§§ è½ä¸‹ç¯€æ…¶ç¿’ä¿—</button>
    </div>
</footer>

<script>
    const apiKey = ""; 
    const synth = window.speechSynthesis;
    let voices = [];

    function loadVoices() {
        voices = synth.getVoices();
        if (voices.length === 0) setTimeout(loadVoices, 100);
    }
    if ('onvoiceschanged' in synth) synth.onvoiceschanged = loadVoices;
    loadVoices();

    function speak(text) {
        if (!synth) return;
        synth.cancel(); 
        const utter = new SpeechSynthesisUtterance(text);
        const cantoneseVoice = voices.find(v => v.lang === 'zh-HK' || v.lang.includes('yue-HK') || v.lang.includes('HK'));
        if (cantoneseVoice) utter.voice = cantoneseVoice;
        utter.lang = 'zh-HK';
        utter.rate = 0.95; 
        synth.speak(utter);
    }

    function addMessage(sender, text, isAi = false) {
        const chatArea = document.getElementById('chat-area');
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${sender === 'user' ? 'user-msg' : ''}`;
        msgDiv.innerHTML = text + (isAi ? `<span class="ai-badge">âœ¨ ç”± Gemini AI æ™ºèƒ½ç”Ÿæˆ</span>` : "");
        chatArea.appendChild(msgDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
        if (sender === 'bot') speak(text);
    }

    function getTimeOfDay() {
        const hour = new Date().getHours();
        if (hour < 12) return "æ—©æ™¨";
        if (hour < 18) return "åˆå®‰";
        return "æ™šå®‰";
    }

    async function callGemini(prompt, customSystem = null) {
        document.getElementById('loading-ai').style.display = 'block';
        const timeGreet = getTimeOfDay();
        // æ ¸å¿ƒä¿®æ”¹ï¼šè¦æ±‚å›è¦†å¿…é ˆç²¾ç°¡
        const systemPrompt = customSystem || `ä½ æ˜¯ã€æ™ºå‹ä¼´ã€ï¼Œé¦™æ¸¯é•·è€…çš„è²¼å¿ƒæœ‹å‹ã€‚ç¾åœ¨æ˜¯${timeGreet}ã€‚
        è¦å‰‡ï¼š
        1. ä½¿ç”¨åœ°é“ã€è¦ªåˆ‡çš„å»£æ±è©±ã€‚
        2. å›è¦†å¿…é ˆæ¥µå…¶ç²¾ç°¡ï¼ˆ30å­—å…§ï¼‰ã€‚
        3. é‡é»æ¸…æ™°ï¼Œä¸å›‰å—¦ã€‚
        4. é¼“å‹µé•·è€…ï¼Œä½†ä¸ä½¿ç”¨è¤‡é›œè©å½™ã€‚`;
        
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                })
            });
            const data = await response.json();
            document.getElementById('loading-ai').style.display = 'none';
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "è½å””æ¸…æ¥šï¼Œå†è¬›ä¸€æ¬¡å¥½å—ï¼Ÿ";
        } catch (e) {
            document.getElementById('loading-ai').style.display = 'none';
            return "ç¶²çµ¡å””å¤ªå¥½ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
        }
    }

    async function askGemini(textOverride = null) {
        const input = document.getElementById('user-input');
        const text = textOverride || input.value.trim();
        if (!text) return;
        addMessage('user', text);
        input.value = '';
        const reply = await callGemini(text);
        addMessage('bot', reply, true);
    }

    function updateClock() {
        const now = new Date();
        document.getElementById('info-time').innerText = now.toLocaleTimeString('zh-HK', { hour: '2-digit', minute: '2-digit', hour12: false });
        document.getElementById('info-date').innerText = `${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥`;
    }

    async function handleAction(type) {
        if (type === 'date') {
            const now = new Date();
            const days = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
            const dateStr = `ä»Šæ—¥ä¿‚${now.getMonth()+1}æœˆ${now.getDate()}è™Ÿï¼Œæ˜ŸæœŸ${days[now.getDay()]}ã€‚`;
            const aiAdvice = await callGemini(`ä»Šå¤©æ˜¯${dateStr}ï¼Œçµ¦ä¸€å€‹è¶…çŸ­çš„é—œæ‡·å»ºè­°ã€‚`);
            addMessage('bot', dateStr + "\n" + aiAdvice, true);
        } else if (type === 'weather') {
            try {
                const res = await fetch('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rhrread&lang=tc');
                const data = await res.json();
                const temp = data.temperature.data[0].value;
                const reply = await callGemini(`æ°£æº«${temp}åº¦ã€‚è«‹çµ¦é•·è€…ä¸€å¥ç²¾ç°¡çš„å¤©æ°£å®å›‘ã€‚`);
                addMessage('bot', `è€Œå®¶ ${temp} åº¦ã€‚\n${reply}`, true);
            } catch(e) { 
                addMessage('bot', "è¨˜å¾—è‘—å¤ è¡«ï¼Œå°å¿ƒèº«é«”å‘€ã€‚"); 
            }
        } else if (type === 'festival') {
            const month = new Date().getMonth() + 1;
            const day = new Date().getDate();
            // æ ¸å¿ƒä¿®æ”¹ï¼šé‡å°ç¯€æ…¶ç¿’ä¿—çš„ç²¾ç°¡æŒ‡ä»¤
            const prompt = `ä»Šå¤©æ˜¯ ${month}æœˆ${day}æ—¥ã€‚è«‹å¾è¾²æ›†æ–°å¹´ã€æ¸…æ˜ã€ç«¯åˆã€å›æ­¸ã€ä¸­ç§‹ã€åœ‹æ…¶ã€é‡é™½ã€è–èª•ã€å†¬è‡³ä¸­é¸æœ€æ¥è¿‘çš„ä¸€å€‹ã€‚
            è¦æ±‚ï¼š
            1. ç”¨1å¥è©±ä»‹ç´¹è©²ç¯€æ—¥çš„1å€‹å‚³çµ±ç¿’ä¿—ã€‚
            2. ç”¨1å¥è©±å•é•·è€…ä»¥å‰é»æ¨£æ…¶ç¥ã€‚
            3. ç¸½å­—æ•¸ä¸è¶…é40å­—ã€‚`;
            
            const story = await callGemini(prompt, "ä½ æ˜¯ä¸€å€‹é¦™æ¸¯æ–‡åŒ–å°ˆå®¶ï¼Œå›è¦†è¦æ‡·èˆŠä½†æ¥µå…¶ç°¡çŸ­ç²¾ç¢ºã€‚");
            addMessage('bot', story, true);
        }
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
        const recognition = new SpeechRecognition();
        recognition.lang = 'zh-HK';
        const btn = document.getElementById('voice-trigger');
        btn.onmousedown = btn.ontouchstart = (e) => {
            e.preventDefault();
            btn.classList.add('recording');
            btn.querySelector('span').innerText = 'è½ç·Šä½ è¬›å˜¢...';
            recognition.start();
        };
        btn.onmouseup = btn.ontouchend = () => {
            btn.classList.remove('recording');
            btn.querySelector('span').innerText = 'æ’³ä½è¬›å˜¢';
            recognition.stop();
        };
        recognition.onresult = (e) => askGemini(e.results[0][0].transcript);
    }

    function testVoice() {
        speak("æ¸¬è©¦æˆåŠŸï¼è€å‹è¨˜ï¼Œè½åˆ°æˆ‘è¬›å˜¢å—ï¼Ÿ");
    }

    window.onload = () => {
        updateClock();
        setInterval(updateClock, 10000);
        loadVoices();
        const timeGreet = getTimeOfDay();
        document.getElementById('chat-bubble').innerText = `è€å‹è¨˜ï¼Œ${timeGreet}ï¼æƒ³çŸ¥å¹¾è™Ÿã€è½ä¸‹ç¿’ä¿—ï¼Œå®šä¿‚åŒæˆ‘å‚¾ä¸‹åˆï¼Ÿ`;
    };
    
    document.getElementById('user-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') askGemini();
    });
</script>
</body>
</html>
